{"id":"14764165046","type":"IssueCommentEvent","actor":{"id":21283655,"login":"Hatzen","display_login":"Hatzen","gravatar_id":"","url":"https://api.github.com/users/Hatzen","avatar_url":"https://avatars.githubusercontent.com/u/21283655?"},"repo":{"id":247826799,"name":"open-quantum-safe/liboqs-java","url":"https://api.github.com/repos/open-quantum-safe/liboqs-java"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11","repository_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java","labels_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11/labels{/name}","comments_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11/comments","events_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11/events","html_url":"https://github.com/open-quantum-safe/liboqs-java/issues/11","id":778307621,"node_id":"MDU6SXNzdWU3NzgzMDc2MjE=","number":11,"title":"Enable Build for other Platforms like ARM (Android)","user":{"login":"Hatzen","id":21283655,"node_id":"MDQ6VXNlcjIxMjgzNjU1","avatar_url":"https://avatars0.githubusercontent.com/u/21283655?v=4","gravatar_id":"","url":"https://api.github.com/users/Hatzen","html_url":"https://github.com/Hatzen","followers_url":"https://api.github.com/users/Hatzen/followers","following_url":"https://api.github.com/users/Hatzen/following{/other_user}","gists_url":"https://api.github.com/users/Hatzen/gists{/gist_id}","starred_url":"https://api.github.com/users/Hatzen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hatzen/subscriptions","organizations_url":"https://api.github.com/users/Hatzen/orgs","repos_url":"https://api.github.com/users/Hatzen/repos","events_url":"https://api.github.com/users/Hatzen/events{/privacy}","received_events_url":"https://api.github.com/users/Hatzen/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-01-04T19:23:54Z","updated_at":"2021-01-09T13:20:30Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"First of all thanks for your good work :)  \r\nI am trying to get the lib working for android.  Regarding https://github.com/open-quantum-safe/liboqs/issues/594 i am able to get a working .so file for android and the passed abi.  \r\nBut i am struggeling to get it working with this repository and jni.  \r\nWhen i just compile the library for armv8a and then using this repo to get the jni wrapper it fails as the target system (x86) differs at compile time.     \r\n\r\n<details>    \r\n<summary>Excerpt of the error message</summary>   \r\n\r\n```\r\n[INFO] /bin/sh -c cd '/home/hatzen/liboqs-java' && 'gcc' '-shared' '-L/home/hatzen/liboqs/build/lib' '-o/home/hatzen/liboqs-java/target/liboqs-java.jar' 'target/objs/handle.o' 'target/objs/KEMs.o' 'target/objs/KeyEncapsulation.o' 'target/objs/Rand.o' 'target/objs/Signature.o' 'target/objs/Sigs.o' '-o' '/home/hatzen/liboqs-java/src/main/resources/liboqs-jni.so' '-loqs'\r\n/usr/bin/ld: skipping incompatible /home/hatzen/liboqs/build/lib/liboqs.so when searching for -loqs\r\n/usr/bin/ld: cannot find -loqs\r\ncollect2: error: ld returned 1 exit status\r\n```\r\n</details>  \r\n  \r\nSo i tried to copy the necessary files and build jni and liboqs at a single time with the given cmake files.  \r\nI copied all c sources and tried to add them to the cmakefile. Buti get errors when running the java test.    \r\n  \r\n<details>\r\n<summary>Excerpts of changed files</summary>  \r\n  \r\nsrc/CMakeList.txt\r\n```cmake  \r\n...\r\ninclude_directories(jni)\r\nlink_directories(jni oqs)\r\n\r\nadd_library(jni SHARED\r\njni/handle.c\r\njni/KEMs.c\r\njni/KeyEncapsulation.c\r\njni/Rand.c\r\njni/Signature.c\r\njni/Sigs.c)\r\n\r\nset_target_properties(\r\n    jni\r\n    PROPERTIES\r\n    COMPILE_FLAGS \"-w\"\r\n    #COMPILE_WARNING_DISABLED high\r\n)\r\ntarget_link_libraries(jni oqs)\r\n\r\nset_target_properties(jni PROPERTIES PUBLIC_HEADER \"jni/handle.h;jni/KEMs.h;jni/KeyEncapsulation.h;jni/Rand.h;jni/Signature.h;jni/Sigs.h\")\r\n\r\nINSTALL(TARGETS jni\r\n        LIBRARY DESTINATION lib\r\n        PUBLIC_HEADER DESTINATION lib\r\n)\r\n...\r\n```   \r\nAnd i have overriden the Common Class of this Repo: \r\n\r\n```java\r\npublic class Common {\r\n    ...\r\n    public static void loadNativeLibrary() {\r\n        // overrides all changes from this repo method.\r\n        System.loadLibrary(\"oqs\");\r\n        System.loadLibrary(\"jni\");\r\n   }\r\n   ...\r\n}\r\n```\r\nI did override all packages and paths like:  \r\n```\r\nJava_org_openquantumsafe => Java_de_hartz_software_parannoying_helper_security_liboqs_java\r\norg/openquantumsafe => de/hartz/software/parannoying/helper/security/liboqs/java\r\n```\r\n\r\nThe crash occours probably on the equivalent of:  \r\nhttps://github.com/open-quantum-safe/liboqs-java/blob/109534741ace8442129b20dce9cfce62aa54048a/src/test/java/org/openquantumsafe/KEMTest.java#L37  \r\nwhich is calling JNI  \r\nhttps://github.com/open-quantum-safe/liboqs-java/blob/109534741ace8442129b20dce9cfce62aa54048a/src/main/c/KeyEncapsulation.c#L41  \r\n\r\n```\r\n2021-01-02 20:21:08.357 7642-7697/de.hartz.software.parannoying E/zygote64: JNI ERROR (app bug): accessed stale Local 0x76e6ea9241  (index 1852746020 in a table of size 2)\r\n2021-01-02 20:21:08.388 7642-7697/de.hartz.software.parannoying A/zygote64: java_vm_ext.cc:534] JNI DETECTED ERROR IN APPLICATION: use of deleted local reference 0x76e6ea9241\r\n2021-01-02 20:21:08.389 7642-7697/de.hartz.software.parannoying A/zygote64: java_vm_ext.cc:534]     from de.hartz.software.parannoying.helper.security.liboqs.java.KeyEncapsulation$KeyEncapsulationDetails de.hartz.software.parannoying.helper.security.liboqs.java.KeyEncapsulation.get_KEM_details()\r\n2021-01-02 20:21:08.389 7642-7697/de.hartz.software.parannoying A/zygote64: java_vm_ext.cc:534] \"Instr: androidx.test.runner.AndroidJUnitRunner\" prio=5 tid=22 Runnable\r\n```\r\n  \r\n</details>\r\n  \r\nI am not very familiar with writing c and never had contact with JNI before.   \r\nSo i am not sure whether it could be simple to solve. So my question is will you consider to make this repo be able to build for different abis at a time?  ","performed_via_github_app":null},"comment":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/comments/757181351","html_url":"https://github.com/open-quantum-safe/liboqs-java/issues/11#issuecomment-757181351","issue_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11","id":757181351,"node_id":"MDEyOklzc3VlQ29tbWVudDc1NzE4MTM1MQ==","user":{"login":"Hatzen","id":21283655,"node_id":"MDQ6VXNlcjIxMjgzNjU1","avatar_url":"https://avatars0.githubusercontent.com/u/21283655?v=4","gravatar_id":"","url":"https://api.github.com/users/Hatzen","html_url":"https://github.com/Hatzen","followers_url":"https://api.github.com/users/Hatzen/followers","following_url":"https://api.github.com/users/Hatzen/following{/other_user}","gists_url":"https://api.github.com/users/Hatzen/gists{/gist_id}","starred_url":"https://api.github.com/users/Hatzen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hatzen/subscriptions","organizations_url":"https://api.github.com/users/Hatzen/orgs","repos_url":"https://api.github.com/users/Hatzen/repos","events_url":"https://api.github.com/users/Hatzen/events{/privacy}","received_events_url":"https://api.github.com/users/Hatzen/received_events","type":"User","site_admin":false},"created_at":"2021-01-09T13:20:29Z","updated_at":"2021-01-09T13:20:29Z","author_association":"NONE","body":"Thanks for your answer. yes i understood that the different abis are the problem, but my trials didnt lead to a solution.   \r\nI tried to compile the JNI files of this `liboqs-java` project with your already set up android build script [android build script](https://github.com/open-quantum-safe/liboqs/blob/main/scripts/build-android.sh). The result are hidden in the `Excerpts of changed files` section of my previous question.  \r\nSo all files are compiled for the correct platform or abi, the both `oqs.so` and `jni.so` files are loaded correctly in the JVM. But when running it fails due to some memory issue as `JNI DETECTED ERROR IN APPLICATION: use of deleted local reference 0x76e6ea9241`.  \r\nI am not sure why this is happening. There might be different reasons for it:  \r\n- i did something wrong with the cmake configuration and renaming the paths\r\n  - probably not as the code is able to compile and run (except of crashing..)\r\n- the JNI files of this repository wont work when compiling for a different abi\r\n- the android system is working differently with native libs. \r\n    - I already looked for this but cant see anything obvious: https://developer.android.com/training/articles/perf-jni#local-and-global-references  \r\n- the excessiv garbage collection and power saving options  of android are collecting references on excecution\r\n- Other configurations  related stuff. I am using kotlin, gradle etc. which might have an impact for some reason?   \r\n  \r\nBut i am not able to find the exact cause on my own. So i hope for someone who can help me :)  ","performed_via_github_app":null}},"public":true,"created_at":"2021-01-09T13:20:30Z","org":{"id":20689385,"login":"open-quantum-safe","gravatar_id":"","url":"https://api.github.com/orgs/open-quantum-safe","avatar_url":"https://avatars.githubusercontent.com/u/20689385?"}}
{"id":"14764448239","type":"IssueCommentEvent","actor":{"id":21283655,"login":"Hatzen","display_login":"Hatzen","gravatar_id":"","url":"https://api.github.com/users/Hatzen","avatar_url":"https://avatars.githubusercontent.com/u/21283655?"},"repo":{"id":247826799,"name":"open-quantum-safe/liboqs-java","url":"https://api.github.com/repos/open-quantum-safe/liboqs-java"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11","repository_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java","labels_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11/labels{/name}","comments_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11/comments","events_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11/events","html_url":"https://github.com/open-quantum-safe/liboqs-java/issues/11","id":778307621,"node_id":"MDU6SXNzdWU3NzgzMDc2MjE=","number":11,"title":"Enable Build for other Platforms like ARM (Android)","user":{"login":"Hatzen","id":21283655,"node_id":"MDQ6VXNlcjIxMjgzNjU1","avatar_url":"https://avatars0.githubusercontent.com/u/21283655?v=4","gravatar_id":"","url":"https://api.github.com/users/Hatzen","html_url":"https://github.com/Hatzen","followers_url":"https://api.github.com/users/Hatzen/followers","following_url":"https://api.github.com/users/Hatzen/following{/other_user}","gists_url":"https://api.github.com/users/Hatzen/gists{/gist_id}","starred_url":"https://api.github.com/users/Hatzen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hatzen/subscriptions","organizations_url":"https://api.github.com/users/Hatzen/orgs","repos_url":"https://api.github.com/users/Hatzen/repos","events_url":"https://api.github.com/users/Hatzen/events{/privacy}","received_events_url":"https://api.github.com/users/Hatzen/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-01-04T19:23:54Z","updated_at":"2021-01-09T14:38:30Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"First of all thanks for your good work :)  \r\nI am trying to get the lib working for android.  Regarding https://github.com/open-quantum-safe/liboqs/issues/594 i am able to get a working .so file for android and the passed abi.  \r\nBut i am struggeling to get it working with this repository and jni.  \r\nWhen i just compile the library for armv8a and then using this repo to get the jni wrapper it fails as the target system (x86) differs at compile time.     \r\n\r\n<details>    \r\n<summary>Excerpt of the error message</summary>   \r\n\r\n```\r\n[INFO] /bin/sh -c cd '/home/hatzen/liboqs-java' && 'gcc' '-shared' '-L/home/hatzen/liboqs/build/lib' '-o/home/hatzen/liboqs-java/target/liboqs-java.jar' 'target/objs/handle.o' 'target/objs/KEMs.o' 'target/objs/KeyEncapsulation.o' 'target/objs/Rand.o' 'target/objs/Signature.o' 'target/objs/Sigs.o' '-o' '/home/hatzen/liboqs-java/src/main/resources/liboqs-jni.so' '-loqs'\r\n/usr/bin/ld: skipping incompatible /home/hatzen/liboqs/build/lib/liboqs.so when searching for -loqs\r\n/usr/bin/ld: cannot find -loqs\r\ncollect2: error: ld returned 1 exit status\r\n```\r\n</details>  \r\n  \r\nSo i tried to copy the necessary files and build jni and liboqs at a single time with the given cmake files.  \r\nI copied all c sources and tried to add them to the cmakefile. Buti get errors when running the java test.    \r\n  \r\n<details>\r\n<summary>Excerpts of changed files</summary>  \r\n  \r\nsrc/CMakeList.txt\r\n```cmake  \r\n...\r\ninclude_directories(jni)\r\nlink_directories(jni oqs)\r\n\r\nadd_library(jni SHARED\r\njni/handle.c\r\njni/KEMs.c\r\njni/KeyEncapsulation.c\r\njni/Rand.c\r\njni/Signature.c\r\njni/Sigs.c)\r\n\r\nset_target_properties(\r\n    jni\r\n    PROPERTIES\r\n    COMPILE_FLAGS \"-w\"\r\n    #COMPILE_WARNING_DISABLED high\r\n)\r\ntarget_link_libraries(jni oqs)\r\n\r\nset_target_properties(jni PROPERTIES PUBLIC_HEADER \"jni/handle.h;jni/KEMs.h;jni/KeyEncapsulation.h;jni/Rand.h;jni/Signature.h;jni/Sigs.h\")\r\n\r\nINSTALL(TARGETS jni\r\n        LIBRARY DESTINATION lib\r\n        PUBLIC_HEADER DESTINATION lib\r\n)\r\n...\r\n```   \r\nAnd i have overriden the Common Class of this Repo: \r\n\r\n```java\r\npublic class Common {\r\n    ...\r\n    public static void loadNativeLibrary() {\r\n        // overrides all changes from this repo method.\r\n        System.loadLibrary(\"oqs\");\r\n        System.loadLibrary(\"jni\");\r\n   }\r\n   ...\r\n}\r\n```\r\nI did override all packages and paths like:  \r\n```\r\nJava_org_openquantumsafe => Java_de_hartz_software_parannoying_helper_security_liboqs_java\r\norg/openquantumsafe => de/hartz/software/parannoying/helper/security/liboqs/java\r\n```\r\n\r\nThe crash occours probably on the equivalent of:  \r\nhttps://github.com/open-quantum-safe/liboqs-java/blob/109534741ace8442129b20dce9cfce62aa54048a/src/test/java/org/openquantumsafe/KEMTest.java#L37  \r\nwhich is calling JNI  \r\nhttps://github.com/open-quantum-safe/liboqs-java/blob/109534741ace8442129b20dce9cfce62aa54048a/src/main/c/KeyEncapsulation.c#L41  \r\n\r\n```\r\n2021-01-02 20:21:08.357 7642-7697/de.hartz.software.parannoying E/zygote64: JNI ERROR (app bug): accessed stale Local 0x76e6ea9241  (index 1852746020 in a table of size 2)\r\n2021-01-02 20:21:08.388 7642-7697/de.hartz.software.parannoying A/zygote64: java_vm_ext.cc:534] JNI DETECTED ERROR IN APPLICATION: use of deleted local reference 0x76e6ea9241\r\n2021-01-02 20:21:08.389 7642-7697/de.hartz.software.parannoying A/zygote64: java_vm_ext.cc:534]     from de.hartz.software.parannoying.helper.security.liboqs.java.KeyEncapsulation$KeyEncapsulationDetails de.hartz.software.parannoying.helper.security.liboqs.java.KeyEncapsulation.get_KEM_details()\r\n2021-01-02 20:21:08.389 7642-7697/de.hartz.software.parannoying A/zygote64: java_vm_ext.cc:534] \"Instr: androidx.test.runner.AndroidJUnitRunner\" prio=5 tid=22 Runnable\r\n```\r\n  \r\n</details>\r\n  \r\nI am not very familiar with writing c and never had contact with JNI before.   \r\nSo i am not sure whether it could be simple to solve. So my question is will you consider to make this repo be able to build for different abis at a time?  ","performed_via_github_app":null},"comment":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/comments/757255673","html_url":"https://github.com/open-quantum-safe/liboqs-java/issues/11#issuecomment-757255673","issue_url":"https://api.github.com/repos/open-quantum-safe/liboqs-java/issues/11","id":757255673,"node_id":"MDEyOklzc3VlQ29tbWVudDc1NzI1NTY3Mw==","user":{"login":"Hatzen","id":21283655,"node_id":"MDQ6VXNlcjIxMjgzNjU1","avatar_url":"https://avatars0.githubusercontent.com/u/21283655?v=4","gravatar_id":"","url":"https://api.github.com/users/Hatzen","html_url":"https://github.com/Hatzen","followers_url":"https://api.github.com/users/Hatzen/followers","following_url":"https://api.github.com/users/Hatzen/following{/other_user}","gists_url":"https://api.github.com/users/Hatzen/gists{/gist_id}","starred_url":"https://api.github.com/users/Hatzen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hatzen/subscriptions","organizations_url":"https://api.github.com/users/Hatzen/orgs","repos_url":"https://api.github.com/users/Hatzen/repos","events_url":"https://api.github.com/users/Hatzen/events{/privacy}","received_events_url":"https://api.github.com/users/Hatzen/received_events","type":"User","site_admin":false},"created_at":"2021-01-09T14:38:30Z","updated_at":"2021-01-09T14:38:30Z","author_association":"NONE","body":"> What are you planning to use it for?\r\n\r\n@dstebila i am working on a messaging app  which should be as secure as possible even if it destroys the user experience. And which hopefully become quantum safe ;)  \r\nDo you ask with an ulterior motive?  ","performed_via_github_app":null}},"public":true,"created_at":"2021-01-09T14:38:30Z","org":{"id":20689385,"login":"open-quantum-safe","gravatar_id":"","url":"https://api.github.com/orgs/open-quantum-safe","avatar_url":"https://avatars.githubusercontent.com/u/20689385?"}}
