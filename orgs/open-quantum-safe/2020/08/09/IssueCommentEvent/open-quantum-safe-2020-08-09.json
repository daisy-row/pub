{"id":"13149532478","type":"IssueCommentEvent","actor":{"id":9383677,"login":"geovandro","display_login":"geovandro","gravatar_id":"","url":"https://api.github.com/users/geovandro","avatar_url":"https://avatars.githubusercontent.com/u/9383677?"},"repo":{"id":65514205,"name":"open-quantum-safe/liboqs","url":"https://api.github.com/repos/open-quantum-safe/liboqs"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/806","repository_url":"https://api.github.com/repos/open-quantum-safe/liboqs","labels_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/806/labels{/name}","comments_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/806/comments","events_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/806/events","html_url":"https://github.com/open-quantum-safe/liboqs/issues/806","id":673630713,"node_id":"MDU6SXNzdWU2NzM2MzA3MTM=","number":806,"title":"Occasional AddressSanitizer error in SIKE compressed","user":{"login":"dstebila","id":8843219,"node_id":"MDQ6VXNlcjg4NDMyMTk=","avatar_url":"https://avatars0.githubusercontent.com/u/8843219?v=4","gravatar_id":"","url":"https://api.github.com/users/dstebila","html_url":"https://github.com/dstebila","followers_url":"https://api.github.com/users/dstebila/followers","following_url":"https://api.github.com/users/dstebila/following{/other_user}","gists_url":"https://api.github.com/users/dstebila/gists{/gist_id}","starred_url":"https://api.github.com/users/dstebila/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dstebila/subscriptions","organizations_url":"https://api.github.com/users/dstebila/orgs","repos_url":"https://api.github.com/users/dstebila/repos","events_url":"https://api.github.com/users/dstebila/events{/privacy}","received_events_url":"https://api.github.com/users/dstebila/received_events","type":"User","site_admin":false},"labels":[{"id":423520874,"node_id":"MDU6TGFiZWw0MjM1MjA4NzQ=","url":"https://api.github.com/repos/open-quantum-safe/liboqs/labels/bug","name":"bug","color":"ee0701","default":true,"description":"Something isn't working"}],"state":"open","locked":false,"assignee":{"login":"christianpaquin","id":16247285,"node_id":"MDQ6VXNlcjE2MjQ3Mjg1","avatar_url":"https://avatars0.githubusercontent.com/u/16247285?v=4","gravatar_id":"","url":"https://api.github.com/users/christianpaquin","html_url":"https://github.com/christianpaquin","followers_url":"https://api.github.com/users/christianpaquin/followers","following_url":"https://api.github.com/users/christianpaquin/following{/other_user}","gists_url":"https://api.github.com/users/christianpaquin/gists{/gist_id}","starred_url":"https://api.github.com/users/christianpaquin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/christianpaquin/subscriptions","organizations_url":"https://api.github.com/users/christianpaquin/orgs","repos_url":"https://api.github.com/users/christianpaquin/repos","events_url":"https://api.github.com/users/christianpaquin/events{/privacy}","received_events_url":"https://api.github.com/users/christianpaquin/received_events","type":"User","site_admin":false},"assignees":[{"login":"christianpaquin","id":16247285,"node_id":"MDQ6VXNlcjE2MjQ3Mjg1","avatar_url":"https://avatars0.githubusercontent.com/u/16247285?v=4","gravatar_id":"","url":"https://api.github.com/users/christianpaquin","html_url":"https://github.com/christianpaquin","followers_url":"https://api.github.com/users/christianpaquin/followers","following_url":"https://api.github.com/users/christianpaquin/following{/other_user}","gists_url":"https://api.github.com/users/christianpaquin/gists{/gist_id}","starred_url":"https://api.github.com/users/christianpaquin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/christianpaquin/subscriptions","organizations_url":"https://api.github.com/users/christianpaquin/orgs","repos_url":"https://api.github.com/users/christianpaquin/repos","events_url":"https://api.github.com/users/christianpaquin/events{/privacy}","received_events_url":"https://api.github.com/users/christianpaquin/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2020-08-05T15:29:57Z","updated_at":"2020-08-09T05:52:10Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"body":"A [recent nightly build](https://app.circleci.com/pipelines/github/open-quantum-safe/liboqs/936/workflows/c0f9bfc4-a70d-4c80-8f20-dead27e22a89/jobs/9467) with AddressSanitizer failed for SIKE-p434-compressed.  I tried reproducing locally, and it seems non-deterministic: it fails about 20% of the time when I run locally.\r\n\r\nTwo different errors occur, see logs below.\r\n\r\n## Steps to reproduce\r\n\r\n```\r\ndocker pull openquantumsafe/ci-ubuntu-bionic-x86_64:latest\r\ndocker run -dti openquantumsafe/ci-ubuntu-bionic-x86_64:latest /bin/bash\r\ndocker attach (whatever the output of the previous command was)\r\ngit clone https://github.com/open-quantum-safe/liboqs\r\ncd liboqs\r\nmkdir build && cd build\r\nenv CC=clang-9 cmake -GNinja -DCMAKE_BUILD_TYPE=Debug -DUSE_SANITIZER=Address ..\r\ntests/test_kem SIDH-p434-compressed\r\n```\r\n\r\nYou may have to run the last command (`tests/test_kem SIDH-p434-compressed`) several times to see the error; I observed it only approximately 20% of the time.\r\n\r\n## Error 1\r\n\r\n```\r\n==5049==ERROR: AddressSanitizer: global-buffer-overflow on address 0x000000a20120 at pc 0x000000511e42 bp 0x7f85bd8fd250 sp 0x7f85bd8fd248\r\nREAD of size 8 at 0x000000a20120 thread T1\r\n    #0 0x511e41 in fpcopy434 /root/liboqs/build/../src/kem/sike/external/P434/../fpx.c:94:16\r\n    #1 0x529fc7 in BuildEntangledXonly_Decomp /root/liboqs/build/../src/kem/sike/external/P434/../compression/sidh_compressed.c:1031:9\r\n    #2 0x52969d in PKBDecompression_dual /root/liboqs/build/../src/kem/sike/external/P434/../compression/sidh_compressed.c:1169:5\r\n    #3 0x50efd1 in EphemeralSecretAgreement_A_extended /root/liboqs/build/../src/kem/sike/external/P434/../compression/sidh_compressed.c:1313:9\r\n    #4 0x50eaf6 in oqs_kem_sidh_p434_compressed_EphemeralSecretAgreement_A /root/liboqs/build/../src/kem/sike/external/P434/../compression/sidh_compressed.c:1369:12\r\n    #5 0x4f90d4 in OQS_KEM_sidh_p434_compressed_decaps /root/liboqs/build/../src/kem/sike/kem_sike.c:379:6\r\n    #6 0x4c7afe in OQS_KEM_decaps /root/liboqs/build/../src/kem/kem.c:899:10\r\n    #7 0x4c3b42 in kem_test_correctness /root/liboqs/build/../tests/test_kem.c:118:7\r\n    #8 0x4c2e94 in test_wrapper /root/liboqs/build/../tests/test_kem.c:151:11\r\n    #9 0x7f85c161a6da in start_thread (/lib/x86_64-linux-gnu/libpthread.so.0+0x76da)\r\n    #10 0x7f85c0d1f88e in clone (/lib/x86_64-linux-gnu/libc.so.6+0x12188e)\r\n\r\n0x000000a20120 is located 32 bytes to the left of global variable 'T_tate2_P' defined in '../src/kem/sike/external/P434/P434_compressed_pair_tables.c:1534:23' (0xa20140) of size 35952\r\n0x000000a20120 is located 0 bytes to the right of global variable 'T_tate2_firststep_P' defined in '../src/kem/sike/external/P434/P434_compressed_pair_tables.c:1522:23' (0xa20040) of size 224\r\nSUMMARY: AddressSanitizer: global-buffer-overflow /root/liboqs/build/../src/kem/sike/external/P434/../fpx.c:94:16 in fpcopy434\r\nShadow bytes around the buggy address:\r\n  0x00008013bfd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013bfe0: 00 00 00 00 00 00 00 00 00 00 00 f9 f9 f9 f9 f9\r\n  0x00008013bff0: f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9\r\n  0x00008013c000: f9 f9 f9 f9 f9 f9 f9 f9 00 00 00 00 00 00 00 00\r\n  0x00008013c010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n=>0x00008013c020: 00 00 00 00[f9]f9 f9 f9 00 00 00 00 00 00 00 00\r\n  0x00008013c030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013c040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013c050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013c060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013c070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n  Shadow gap:              cc\r\nThread T1 created by T0 here:\r\n    #0 0x47df1a in pthread_create (/root/liboqs/build/tests/test_kem+0x47df1a)\r\n    #1 0x4c4238 in main /root/liboqs/build/../tests/test_kem.c:198:13\r\n    #2 0x7f85c0c1fb96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)\r\n\r\n==5049==ABORTING\r\n```\r\n\r\n## Error 2\r\n\r\n```\r\n==5064==ERROR: AddressSanitizer: global-buffer-overflow on address 0x000000a1ecd0 at pc 0x000000511b92 bp 0x7f46639fce40 sp 0x7f46639fce38\r\nREAD of size 8 at 0x000000a1ecd0 thread T1\r\n    #0 0x511b91 in mp_add /root/liboqs/build/../src/kem/sike/external/P434/../fpx.c:250:9\r\n    #1 0x5141b9 in mp_addfast /root/liboqs/build/../src/kem/sike/external/P434/../fpx.c:219:2\r\n    #2 0x512964 in fp2mul434_mont /root/liboqs/build/../src/kem/sike/external/P434/../fpx.c:316:5\r\n    #3 0x529f07 in BuildEntangledXonly_Decomp /root/liboqs/build/../src/kem/sike/external/P434/../compression/sidh_compressed.c:1021:5\r\n    #4 0x52969d in PKBDecompression_dual /root/liboqs/build/../src/kem/sike/external/P434/../compression/sidh_compressed.c:1169:5\r\n    #5 0x50efd1 in EphemeralSecretAgreement_A_extended /root/liboqs/build/../src/kem/sike/external/P434/../compression/sidh_compressed.c:1313:9\r\n    #6 0x50eaf6 in oqs_kem_sidh_p434_compressed_EphemeralSecretAgreement_A /root/liboqs/build/../src/kem/sike/external/P434/../compression/sidh_compressed.c:1369:12\r\n    #7 0x4f90d4 in OQS_KEM_sidh_p434_compressed_decaps /root/liboqs/build/../src/kem/sike/kem_sike.c:379:6\r\n    #8 0x4c7afe in OQS_KEM_decaps /root/liboqs/build/../src/kem/kem.c:899:10\r\n    #9 0x4c3b42 in kem_test_correctness /root/liboqs/build/../tests/test_kem.c:118:7\r\n    #10 0x4c2e94 in test_wrapper /root/liboqs/build/../tests/test_kem.c:151:11\r\n    #11 0x7f466775e6da in start_thread (/lib/x86_64-linux-gnu/libpthread.so.0+0x76da)\r\n    #12 0x7f4666e6388e in clone (/lib/x86_64-linux-gnu/libc.so.6+0x12188e)\r\n\r\n0x000000a1ecd0 is located 224 bytes to the right of global variable 'table_v_qnr' defined in '../src/kem/sike/external/P434/P434_compressed.c:288:23' (0xa1e480) of size 1904\r\nSUMMARY: AddressSanitizer: global-buffer-overflow /root/liboqs/build/../src/kem/sike/external/P434/../fpx.c:250:9 in mp_add\r\nShadow bytes around the buggy address:\r\n  0x00008013bd40: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013bd50: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013bd60: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013bd70: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 f9 f9\r\n  0x00008013bd80: f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9\r\n=>0x00008013bd90: f9 f9 f9 f9 f9 f9 f9 f9 f9 f9[f9]f9 f9 f9 f9 f9\r\n  0x00008013bda0: f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9\r\n  0x00008013bdb0: f9 f9 f9 f9 f9 f9 f9 f9 00 00 00 00 00 00 00 00\r\n  0x00008013bdc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013bdd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x00008013bde0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n  Shadow gap:              cc\r\nThread T1 created by T0 here:\r\n    #0 0x47df1a in pthread_create (/root/liboqs/build/tests/test_kem+0x47df1a)\r\n    #1 0x4c4238 in main /root/liboqs/build/../tests/test_kem.c:198:13\r\n    #2 0x7f4666d63b96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)\r\n\r\n==5064==ABORTING\r\n```","performed_via_github_app":null},"comment":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/comments/671010455","html_url":"https://github.com/open-quantum-safe/liboqs/issues/806#issuecomment-671010455","issue_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/806","id":671010455,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MTAxMDQ1NQ==","user":{"login":"geovandro","id":9383677,"node_id":"MDQ6VXNlcjkzODM2Nzc=","avatar_url":"https://avatars0.githubusercontent.com/u/9383677?v=4","gravatar_id":"","url":"https://api.github.com/users/geovandro","html_url":"https://github.com/geovandro","followers_url":"https://api.github.com/users/geovandro/followers","following_url":"https://api.github.com/users/geovandro/following{/other_user}","gists_url":"https://api.github.com/users/geovandro/gists{/gist_id}","starred_url":"https://api.github.com/users/geovandro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/geovandro/subscriptions","organizations_url":"https://api.github.com/users/geovandro/orgs","repos_url":"https://api.github.com/users/geovandro/repos","events_url":"https://api.github.com/users/geovandro/events{/privacy}","received_events_url":"https://api.github.com/users/geovandro/received_events","type":"User","site_admin":false},"created_at":"2020-08-09T05:52:10Z","updated_at":"2020-08-09T05:52:10Z","author_association":"NONE","body":"This issue was triggered by the \"invalid ciphertext\" test performed by libOQS test_kem program. The test generates a fully random (not genuine) ciphertext as input to the decapsulation algorithm. It turns out that one of the parameters in the ciphertext is an entry for a lookup table, so the random ciphertext would select a random entry that could be outside the table limits. \r\nA pull request with a fix is provided.\r\n\r\nhttps://github.com/microsoft/PQCrypto-SIDH/pull/31","performed_via_github_app":null}},"public":true,"created_at":"2020-08-09T05:52:11Z","org":{"id":20689385,"login":"open-quantum-safe","gravatar_id":"","url":"https://api.github.com/orgs/open-quantum-safe","avatar_url":"https://avatars.githubusercontent.com/u/20689385?"}}
