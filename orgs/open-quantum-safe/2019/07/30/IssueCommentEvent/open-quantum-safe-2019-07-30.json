{"id":"10110813995","type":"IssueCommentEvent","actor":{"id":25283073,"login":"RicardoGaGu","display_login":"RicardoGaGu","gravatar_id":"","url":"https://api.github.com/users/RicardoGaGu","avatar_url":"https://avatars.githubusercontent.com/u/25283073?"},"repo":{"id":66578799,"name":"open-quantum-safe/openssl","url":"https://api.github.com/repos/open-quantum-safe/openssl"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/open-quantum-safe/openssl/issues/103","repository_url":"https://api.github.com/repos/open-quantum-safe/openssl","labels_url":"https://api.github.com/repos/open-quantum-safe/openssl/issues/103/labels{/name}","comments_url":"https://api.github.com/repos/open-quantum-safe/openssl/issues/103/comments","events_url":"https://api.github.com/repos/open-quantum-safe/openssl/issues/103/events","html_url":"https://github.com/open-quantum-safe/openssl/issues/103","id":472766958,"node_id":"MDU6SXNzdWU0NzI3NjY5NTg=","number":103,"title":"Failing to compile NGINX with PQ openssl fork","user":{"login":"RicardoGaGu","id":25283073,"node_id":"MDQ6VXNlcjI1MjgzMDcz","avatar_url":"https://avatars3.githubusercontent.com/u/25283073?v=4","gravatar_id":"","url":"https://api.github.com/users/RicardoGaGu","html_url":"https://github.com/RicardoGaGu","followers_url":"https://api.github.com/users/RicardoGaGu/followers","following_url":"https://api.github.com/users/RicardoGaGu/following{/other_user}","gists_url":"https://api.github.com/users/RicardoGaGu/gists{/gist_id}","starred_url":"https://api.github.com/users/RicardoGaGu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RicardoGaGu/subscriptions","organizations_url":"https://api.github.com/users/RicardoGaGu/orgs","repos_url":"https://api.github.com/users/RicardoGaGu/repos","events_url":"https://api.github.com/users/RicardoGaGu/events{/privacy}","received_events_url":"https://api.github.com/users/RicardoGaGu/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2019-07-25T09:42:07Z","updated_at":"2019-07-30T11:12:34Z","closed_at":null,"author_association":"NONE","body":"HI! I'm trying to compile the PQ OpenSSL fork into NGINX, I've run into some problems when building nginx wirth openssl underneath. I'll show my Dockerfile to clarify my procedure for installing Nginx. I have tested the TLS demo and works fine, but when configuring Nginx on Ubuntu 18.04 it fails. I kindly ask if anyone know how to solve this problem.\r\n\r\n```\r\nFROM ubuntu:18.04\r\n\r\n### Building NGINX from source with post quantum openssl for TLS connections\r\nRUN apt update && apt upgrade -y\r\nRUN apt install wget autoconf automake libtool libssl-dev make unzip xsltproc git -y\r\nRUN apt install build-essential -y\r\n\r\n### Step 1: Build required libraries: pcre, zlib and quantum safe openssl\r\n\r\n### PCRE\r\nRUN wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.42.tar.gz && \\\r\n tar -zxf pcre-8.42.tar.gz && \\\r\n cd pcre-8.42 && \\\r\n ./configure && \\\r\n make && \\\r\n make install\r\n### ZLIB\r\nRUN wget http://zlib.net/zlib-1.2.11.tar.gz && \\\r\n tar -zxf zlib-1.2.11.tar.gz && \\\r\n cd zlib-1.2.11 && \\\r\n ./configure && \\\r\n make && \\\r\n make install\r\n\r\n\r\n### Install liboqs\r\nWORKDIR /usr/local/\r\n\r\nRUN git clone --branch OQS-OpenSSL_1_1_1-stable https://github.com/open-quantum-safe/openssl.git\r\n\r\nRUN git clone --branch master https://github.com/open-quantum-safe/liboqs.git\r\n\r\nWORKDIR /usr/local/liboqs\r\nRUN autoreconf -i\r\nRUN ./configure --prefix=/usr/local/openssl/oqs --enable-shared=no\r\nRUN make -j\r\nRUN make install\r\n\r\n### Install openssl\r\nWORKDIR /usr/local/openssl\r\nRUN ./config --prefix=/usr/local/openssl -Wl,-rpath -Wl,/usr/local/openssl/oqs/lib\r\nRUN make -j\r\n\r\nRUN cp libcrypto.so.1.1 ./oqs/lib\r\nRUN cp libssl.so.1.1 ./oqs/lib\r\n\r\nWORKDIR /\r\n\r\n### Step 2: Download NGINX and RTMP module\r\nRUN wget https://nginx.org/download/nginx-1.15.11.tar.gz && \\\r\n tar zxf nginx-1.15.11.tar.gz\r\n\r\nRUN wget https://github.com/arut/nginx-rtmp-module/archive/master.zip && \\\r\n unzip master.zip\r\n\r\nRUN rm -rf *.tar.gz\r\n\r\n### Step 3: Build and install NGINX\r\nRUN wget https://nginx.org/download/nginx-1.15.11.tar.gz && \\\r\n tar zxf nginx-1.15.11.tar.gz\r\n\r\nRUN   cd nginx-1.15.11 && ./configure \\\r\n--with-cc-opt=\"-I /usr/local/openssl/oqs/include/\" \\\r\n--with-ld-opt=\"-L /usr/local/openssl/oqs/lib/\"\\\r\n--sbin-path=/usr/local/nginx/nginx \\\r\n--conf-path=/usr/local/nginx/nginx.conf \\\r\n--pid-path=/usr/local/nginx/nginx.pid \\\r\n--with-pcre=../pcre-8.42 \\\r\n--with-zlib=../zlib-1.2.11 \\\r\n--with-openssl=/usr/local/openssl \\\r\n--with-http_ssl_module \\\r\n--with-stream \\\r\n--with-mail=dynamic \\\r\n--add-module=/nginx-rtmp-module-master && \\\r\nmake && \\\r\nmake install\r\n```\r\n\r\nThe error is the following:\r\n\r\n/usr/local/openssl/.openssl/lib/libssl.a(s3_lib.o): In function `ssl3_clear':\r\ns3_lib.c:(.text+0x51b): undefined reference to `OQS_KEM_free'\r\n/usr/local/openssl/.openssl/lib/libssl.a(extensions_clnt.o): In function `tls_construct_ctos_key_share':\r\nextensions_clnt.c:(.text+0x18af): undefined reference to `OQS_KEM_new'\r\nextensions_clnt.c:(.text+0x1952): undefined reference to `OQS_KEM_keypair'\r\nextensions_clnt.c:(.text+0x199c): undefined reference to `OQS_MEM_secure_free'\r\nextensions_clnt.c:(.text+0x19a4): undefined reference to `OQS_MEM_insecure_free'\r\nextensions_clnt.c:(.text+0x19c2): undefined reference to `OQS_KEM_free'\r\n/usr/local/openssl/.openssl/lib/libssl.a(extensions_clnt.o): In function `tls_parse_stoc_key_share':\r\nextensions_clnt.c:(.text+0x3c96): undefined reference to `OQS_MEM_secure_free'\r\nextensions_clnt.c:(.text+0x3cb4): undefined reference to `OQS_MEM_secure_free'\r\nextensions_clnt.c:(.text+0x3cd2): undefined reference to `OQS_KEM_free'\r\nextensions_clnt.c:(.text+0x3d77): undefined reference to `OQS_KEM_decaps'\r\n/usr/local/openssl/.openssl/lib/libssl.a(extensions_srvr.o): In function `tls_construct_stoc_key_share':\r\nextensions_srvr.c:(.text+0x3769): undefined reference to `OQS_KEM_new'\r\nextensions_srvr.c:(.text+0x37be): undefined reference to `OQS_KEM_encaps'\r\nextensions_srvr.c:(.text+0x3906): undefined reference to `OQS_MEM_secure_free'\r\nextensions_srvr.c:(.text+0x390e): undefined reference to `OQS_KEM_free'\r\nextensions_srvr.c:(.text+0x3aeb): undefined reference to `OQS_MEM_secure_free'\r\nextensions_srvr.c:(.text+0x3af3): undefined reference to `OQS_KEM_free'\r\n/usr/local/openssl/.openssl/lib/libcrypto.a(oqs_meth.o): In function `pkey_oqs_digestverify':\r\noqs_meth.c:(.text+0x101): undefined reference to `OQS_SIG_verify'\r\n/usr/local/openssl/.openssl/lib/libcrypto.a(oqs_meth.o): In function `pkey_oqs_digestsign':\r\noqs_meth.c:(.text+0x62f): undefined reference to `OQS_SIG_sign'\r\n/usr/local/openssl/.openssl/lib/libcrypto.a(oqs_meth.o): In function `oqs_free':\r\noqs_meth.c:(.text+0x1d0e): undefined reference to `OQS_SIG_free'\r\n/usr/local/openssl/.openssl/lib/libcrypto.a(oqs_meth.o): In function `oqs_key_init':\r\noqs_meth.c:(.text+0x1df9): undefined reference to `OQS_SIG_new'\r\noqs_meth.c:(.text+0x1f30): undefined reference to `OQS_SIG_free'\r\n/usr/local/openssl/.openssl/lib/libcrypto.a(oqs_meth.o): In function `oqs_priv_decode':\r\noqs_meth.c:(.text+0x22f6): undefined reference to `OQS_SIG_free'\r\n/usr/local/openssl/.openssl/lib/libcrypto.a(oqs_meth.o): In function `pkey_oqs_keygen':\r\noqs_meth.c:(.text+0x2528): undefined reference to `OQS_SIG_new'\r\noqs_meth.c:(.text+0x273c): undefined reference to `OQS_SIG_keypair'\r\noqs_meth.c:(.text+0x2778): undefined reference to `OQS_SIG_free'\r\noqs_meth.c:(.text+0x2810): undefined reference to `OQS_SIG_free'\r\n/usr/local/openssl/.openssl/lib/libcrypto.a(oqs_meth.o): In function `oqs_pub_decode':\r\noqs_meth.c:(.text+0x2b6a): undefined reference to `OQS_SIG_free'\r\ncollect2: error: ld returned 1 exit status\r\nobjs/Makefile:323: recipe for target 'objs/nginx' failed\r\nmake[1]: Leaving directory '/nginx-1.15.11'\r\nmake[1]: *** [objs/nginx] Error 1\r\nMakefile:8: recipe for target 'build' failed\r\nmake: *** [build] Error 2\r\n\r\n\r\nThanks!"},"comment":{"url":"https://api.github.com/repos/open-quantum-safe/openssl/issues/comments/516374795","html_url":"https://github.com/open-quantum-safe/openssl/issues/103#issuecomment-516374795","issue_url":"https://api.github.com/repos/open-quantum-safe/openssl/issues/103","id":516374795,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjM3NDc5NQ==","user":{"login":"RicardoGaGu","id":25283073,"node_id":"MDQ6VXNlcjI1MjgzMDcz","avatar_url":"https://avatars3.githubusercontent.com/u/25283073?v=4","gravatar_id":"","url":"https://api.github.com/users/RicardoGaGu","html_url":"https://github.com/RicardoGaGu","followers_url":"https://api.github.com/users/RicardoGaGu/followers","following_url":"https://api.github.com/users/RicardoGaGu/following{/other_user}","gists_url":"https://api.github.com/users/RicardoGaGu/gists{/gist_id}","starred_url":"https://api.github.com/users/RicardoGaGu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RicardoGaGu/subscriptions","organizations_url":"https://api.github.com/users/RicardoGaGu/orgs","repos_url":"https://api.github.com/users/RicardoGaGu/repos","events_url":"https://api.github.com/users/RicardoGaGu/events{/privacy}","received_events_url":"https://api.github.com/users/RicardoGaGu/received_events","type":"User","site_admin":false},"created_at":"2019-07-30T11:12:34Z","updated_at":"2019-07-30T11:12:34Z","author_association":"NONE","body":"Sorry for the lateness, but I've finally been able to compile your OpenSSL fork into Nginx. I've followed Christian's suggestions and I think the issue is best solved by manually editing Nginx makefile and incorporating the liboqs.a at the end of the linker options. Order does matter indeed!"}},"public":true,"created_at":"2019-07-30T11:12:35Z","org":{"id":20689385,"login":"open-quantum-safe","gravatar_id":"","url":"https://api.github.com/orgs/open-quantum-safe","avatar_url":"https://avatars.githubusercontent.com/u/20689385?"}}
