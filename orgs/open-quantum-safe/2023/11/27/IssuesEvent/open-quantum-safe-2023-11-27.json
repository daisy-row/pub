{"id":"33649084356","type":"IssuesEvent","actor":{"id":44332830,"login":"Majidk409","display_login":"Majidk409","gravatar_id":"","url":"https://api.github.com/users/Majidk409","avatar_url":"https://avatars.githubusercontent.com/u/44332830?"},"repo":{"id":65514205,"name":"open-quantum-safe/liboqs","url":"https://api.github.com/repos/open-quantum-safe/liboqs"},"payload":{"action":"opened","issue":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616","repository_url":"https://api.github.com/repos/open-quantum-safe/liboqs","labels_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/labels{/name}","comments_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/comments","events_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/events","html_url":"https://github.com/open-quantum-safe/liboqs/issues/1616","id":2012274006,"node_id":"I_kwDOA-eq3c538N1W","number":1616,"title":"version problem","user":{"login":"Majidk409","id":44332830,"node_id":"MDQ6VXNlcjQ0MzMyODMw","avatar_url":"https://avatars.githubusercontent.com/u/44332830?v=4","gravatar_id":"","url":"https://api.github.com/users/Majidk409","html_url":"https://github.com/Majidk409","followers_url":"https://api.github.com/users/Majidk409/followers","following_url":"https://api.github.com/users/Majidk409/following{/other_user}","gists_url":"https://api.github.com/users/Majidk409/gists{/gist_id}","starred_url":"https://api.github.com/users/Majidk409/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Majidk409/subscriptions","organizations_url":"https://api.github.com/users/Majidk409/orgs","repos_url":"https://api.github.com/users/Majidk409/repos","events_url":"https://api.github.com/users/Majidk409/events{/privacy}","received_events_url":"https://api.github.com/users/Majidk409/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-11-27T13:28:07Z","updated_at":"2023-11-27T13:28:07Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"/usr/local/lib/python3.10/dist-packages/liboqs_python-0.9.0-py3.10.egg/oqs/oqs.py:75: UserWarning: liboqs version 0.10.0-dev differs from liboqs-python version 0.9.0\r\n","reactions":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/timeline","performed_via_github_app":null,"state_reason":null}},"public":true,"created_at":"2023-11-27T13:28:09Z","org":{"id":20689385,"login":"open-quantum-safe","gravatar_id":"","url":"https://api.github.com/orgs/open-quantum-safe","avatar_url":"https://avatars.githubusercontent.com/u/20689385?"}}
{"id":"33649481717","type":"IssuesEvent","actor":{"id":6541356,"login":"Martyrshot","display_login":"Martyrshot","gravatar_id":"","url":"https://api.github.com/users/Martyrshot","avatar_url":"https://avatars.githubusercontent.com/u/6541356?"},"repo":{"id":65514205,"name":"open-quantum-safe/liboqs","url":"https://api.github.com/repos/open-quantum-safe/liboqs"},"payload":{"action":"closed","issue":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616","repository_url":"https://api.github.com/repos/open-quantum-safe/liboqs","labels_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/labels{/name}","comments_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/comments","events_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/events","html_url":"https://github.com/open-quantum-safe/liboqs/issues/1616","id":2012274006,"node_id":"I_kwDOA-eq3c538N1W","number":1616,"title":"version problem","user":{"login":"Majidk409","id":44332830,"node_id":"MDQ6VXNlcjQ0MzMyODMw","avatar_url":"https://avatars.githubusercontent.com/u/44332830?v=4","gravatar_id":"","url":"https://api.github.com/users/Majidk409","html_url":"https://github.com/Majidk409","followers_url":"https://api.github.com/users/Majidk409/followers","following_url":"https://api.github.com/users/Majidk409/following{/other_user}","gists_url":"https://api.github.com/users/Majidk409/gists{/gist_id}","starred_url":"https://api.github.com/users/Majidk409/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Majidk409/subscriptions","organizations_url":"https://api.github.com/users/Majidk409/orgs","repos_url":"https://api.github.com/users/Majidk409/repos","events_url":"https://api.github.com/users/Majidk409/events{/privacy}","received_events_url":"https://api.github.com/users/Majidk409/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-11-27T13:28:07Z","updated_at":"2023-11-27T13:40:44Z","closed_at":"2023-11-27T13:40:43Z","author_association":"NONE","active_lock_reason":null,"body":"/usr/local/lib/python3.10/dist-packages/liboqs_python-0.9.0-py3.10.egg/oqs/oqs.py:75: UserWarning: liboqs version 0.10.0-dev differs from liboqs-python version 0.9.0\r\n","reactions":{"url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/open-quantum-safe/liboqs/issues/1616/timeline","performed_via_github_app":null,"state_reason":"completed"}},"public":true,"created_at":"2023-11-27T13:40:44Z","org":{"id":20689385,"login":"open-quantum-safe","gravatar_id":"","url":"https://api.github.com/orgs/open-quantum-safe","avatar_url":"https://avatars.githubusercontent.com/u/20689385?"}}
{"id":"33656920074","type":"IssuesEvent","actor":{"id":50673096,"login":"torben-hansen","display_login":"torben-hansen","gravatar_id":"","url":"https://api.github.com/users/torben-hansen","avatar_url":"https://avatars.githubusercontent.com/u/50673096?"},"repo":{"id":113904471,"name":"open-quantum-safe/openssh","url":"https://api.github.com/repos/open-quantum-safe/openssh"},"payload":{"action":"opened","issue":{"url":"https://api.github.com/repos/open-quantum-safe/openssh/issues/150","repository_url":"https://api.github.com/repos/open-quantum-safe/openssh","labels_url":"https://api.github.com/repos/open-quantum-safe/openssh/issues/150/labels{/name}","comments_url":"https://api.github.com/repos/open-quantum-safe/openssh/issues/150/comments","events_url":"https://api.github.com/repos/open-quantum-safe/openssh/issues/150/events","html_url":"https://github.com/open-quantum-safe/openssh/issues/150","id":2012750193,"node_id":"I_kwDOBsoLV853-CFx","number":150,"title":"Memory leaks in oqs ecdh path","user":{"login":"torben-hansen","id":50673096,"node_id":"MDQ6VXNlcjUwNjczMDk2","avatar_url":"https://avatars.githubusercontent.com/u/50673096?v=4","gravatar_id":"","url":"https://api.github.com/users/torben-hansen","html_url":"https://github.com/torben-hansen","followers_url":"https://api.github.com/users/torben-hansen/followers","following_url":"https://api.github.com/users/torben-hansen/following{/other_user}","gists_url":"https://api.github.com/users/torben-hansen/gists{/gist_id}","starred_url":"https://api.github.com/users/torben-hansen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/torben-hansen/subscriptions","organizations_url":"https://api.github.com/users/torben-hansen/orgs","repos_url":"https://api.github.com/users/torben-hansen/repos","events_url":"https://api.github.com/users/torben-hansen/events{/privacy}","received_events_url":"https://api.github.com/users/torben-hansen/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-11-27T17:22:45Z","updated_at":"2023-11-27T17:22:45Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I see two memory leaks present in the current code. To setup reproduction:\r\n\r\n1. clone oqs openssh repo\r\n2. `./oqs-scripts/clone_liboqs.sh`\r\n3. `./oqs-scripts/build_liboqs.sh`\r\n4. `./oqs-scripts/build_openssh.sh` (requires openssl 3.x in the usual place)\r\n5. `oqs-test/run_tests.sh` (populates `/regress` repo with useful things)\r\n\r\nModify `sshd_config` to listen on `22222`. Start server:\r\n```\r\n$(pwd)/sshd -ddd -h $(pwd)/regress/host.ecdsa-sha2-nistp256 -f sshd_config\r\n```\r\n\r\n#### Leak 1\r\n\r\n`kex_ecdh_dec_key_group` allocates new memory and saves a reference in `*shared_secretp`. The function is called twice:\r\n* https://github.com/open-quantum-safe/openssh/blob/OQS-v8/kexoqsecdh.c#L254, and\r\n* https://github.com/open-quantum-safe/openssh/blob/OQS-v8/kexoqsecdh.c#L329\r\n\r\n`sshbuf_putb` does not free `ecdh_shared_secret`, even if fully consumed. Hence, memory leaks at function exit.\r\n\r\nTrace with valgrind\r\n```\r\nvalgrind --trace-children=yes --leak-check=full ./ssh -i regress/host.ecdsa-sha2-nistp256 localhost -p 22222 -oKexAlgorithms=ecdh-nistp256-kyber-512r3-sha256-d00@openquantumsafe.org\r\n\r\n[...]\r\n\r\n==639219== 328 (72 direct, 256 indirect) bytes in 1 blocks are definitely lost in loss record 885 of 983                    \r\n==639219==    at 0x4848464: calloc (vg_replace_malloc.c:1328)                                                               \r\n==639219==    by 0x142B50: sshbuf_new (sshbuf.c:73)                                                                         \r\n==639219==    by 0x1B6968: kex_ecdh_dec_key_group.constprop.0 (kexoqsecdh.c:57)                                             \r\n==639219==    by 0x1B6D53: kex_kem_generic_with_ec_dec (kexoqsecdh.c:329)                                                   \r\n==639219==    by 0x1B82FC: kex_kem_kyber_512_ecdh_nistp256_dec (kexoqsecdh.c:638)                                           \r\n==639219==    by 0x1A1EDE: input_kex_gen_reply (kexgen.c:440)                                                               \r\n==639219==    by 0x1815A5: ssh_dispatch_run (dispatch.c:113)                                                                \r\n==639219==    by 0x181708: ssh_dispatch_run_fatal (dispatch.c:133)\r\n==639219==    by 0x136CA2: ssh_kex2 (sshconnect2.c:346)\r\n==639219==    by 0x131F7D: ssh_login (sshconnect.c:1565)\r\n==639219==    by 0x116C89: main (ssh.c:1680)\r\n```\r\n\r\n#### Leak 2\r\n\r\n`EC_KEY_new_by_curve_name` returns a pointer to newly allocated memory, referenced by `ecdh_client_key`. On the error path, ownership of the memory referenced by `ecdh_client_key` is not transferred to the caller `kex` and therefore leaks when exiting the function.\r\n\r\nImpose deliberate error to trace error path\r\n```\r\ndiff --git a/kexoqsecdh.c b/kexoqsecdh.c\r\nindex 36eabce5..d3447052 100644\r\n--- a/kexoqsecdh.c\r\n+++ b/kexoqsecdh.c\r\n@@ -138,7 +138,7 @@ static int kex_kem_generic_with_ec_keypair(OQS_KEM *kem, struct kex *kex)\r\n     r = SSH_ERR_ALLOC_FAIL;\r\n     goto out;\r\n   }\r\n-  if (EC_KEY_generate_key(ecdh_client_key) != 1) {\r\n+  if (1 || EC_KEY_generate_key(ecdh_client_key) != 1) {\r\n     r = SSH_ERR_LIBCRYPTO_ERROR;\r\n     goto out;\r\n   }\r\n```\r\n\r\nTrace with valgrind\r\n```\r\nvalgrind --trace-children=yes --leak-check=full ./ssh -i regress/host.ecdsa-sha2-nistp256 localhost -p 22222 -oKexAlgorithms=ecdh-nistp256-kyber-512r3-sha256-d00@openquantumsafe.org\r\n\r\n[...]\r\n\r\n==639585== 1,316 (112 direct, 1,204 indirect) bytes in 1 blocks are definitely lost in loss record 856 of 893\r\n==639585==    at 0x484386F: malloc (vg_replace_malloc.c:381)\r\n==639585==    by 0x4A1116D: CRYPTO_zalloc (in /usr/lib64/libcrypto.so.3.0.8)\r\n==639585==    by 0x499DD1D: ??? (in /usr/lib64/libcrypto.so.3.0.8)\r\n==639585==    by 0x499F27C: EC_KEY_new_by_curve_name_ex (in /usr/lib64/libcrypto.so.3.0.8)\r\n==639585==    by 0x1B6866: kex_kem_generic_with_ec_keypair (kexoqsecdh.c:137)\r\n==639585==    by 0x1B809C: kex_kem_kyber_512_ecdh_nistp256_keypair (kexoqsecdh.c:611)\r\n==639585==    by 0x1A24E7: kex_gen_client (kexgen.c:218)\r\n==639585==    by 0x19E2FB: kex_input_kexinit (kex.c:698)\r\n==639585==    by 0x1815A5: ssh_dispatch_run (dispatch.c:113)\r\n==639585==    by 0x181708: ssh_dispatch_run_fatal (dispatch.c:133)\r\n==639585==    by 0x136CA2: ssh_kex2 (sshconnect2.c:346)\r\n==639585==    by 0x131F7D: ssh_login (sshconnect.c:1565)\r\n```","reactions":{"url":"https://api.github.com/repos/open-quantum-safe/openssh/issues/150/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/open-quantum-safe/openssh/issues/150/timeline","performed_via_github_app":null,"state_reason":null}},"public":true,"created_at":"2023-11-27T17:22:46Z","org":{"id":20689385,"login":"open-quantum-safe","gravatar_id":"","url":"https://api.github.com/orgs/open-quantum-safe","avatar_url":"https://avatars.githubusercontent.com/u/20689385?"}}
