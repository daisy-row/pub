{"id":"30257759494","type":"IssueCommentEvent","actor":{"id":57787676,"login":"baentsch","display_login":"baentsch","gravatar_id":"","url":"https://api.github.com/users/baentsch","avatar_url":"https://avatars.githubusercontent.com/u/57787676?"},"repo":{"id":334511511,"name":"open-quantum-safe/oqs-provider","url":"https://api.github.com/repos/open-quantum-safe/oqs-provider"},"payload":{"action":"created","issue":{"url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/207","repository_url":"https://api.github.com/repos/open-quantum-safe/oqs-provider","labels_url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/207/labels{/name}","comments_url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/207/comments","events_url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/207/events","html_url":"https://github.com/open-quantum-safe/oqs-provider/pull/207","id":1787792013,"node_id":"PR_kwDOE_A9l85UnF4B","number":207,"title":"Build a module instead of a shared library.","user":{"login":"thb-sb","id":108470890,"node_id":"U_kgDOBnciag","avatar_url":"https://avatars.githubusercontent.com/u/108470890?v=4","gravatar_id":"","url":"https://api.github.com/users/thb-sb","html_url":"https://github.com/thb-sb","followers_url":"https://api.github.com/users/thb-sb/followers","following_url":"https://api.github.com/users/thb-sb/following{/other_user}","gists_url":"https://api.github.com/users/thb-sb/gists{/gist_id}","starred_url":"https://api.github.com/users/thb-sb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thb-sb/subscriptions","organizations_url":"https://api.github.com/users/thb-sb/orgs","repos_url":"https://api.github.com/users/thb-sb/repos","events_url":"https://api.github.com/users/thb-sb/events{/privacy}","received_events_url":"https://api.github.com/users/thb-sb/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2023-07-04T11:59:21Z","updated_at":"2023-07-07T05:16:13Z","closed_at":"2023-07-07T05:15:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"draft":false,"pull_request":{"url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/pulls/207","html_url":"https://github.com/open-quantum-safe/oqs-provider/pull/207","diff_url":"https://github.com/open-quantum-safe/oqs-provider/pull/207.diff","patch_url":"https://github.com/open-quantum-safe/oqs-provider/pull/207.patch","merged_at":"2023-07-07T05:15:47Z"},"body":"Fix #202.\r\n\r\nThis commit switches the default type in CMake from `SHARED` to `MODULE`.\r\n\r\nTwo issues have been found.\r\n\r\n## First issue\r\n\r\nI ran into an issue while testing this commit on macOS. Here is the error I got from clang:\r\n\r\n```shell\r\nclang: error: invalid argument '-compatibility_version 1.0.0' only allowed with '-dynamiclib'\r\n```\r\n\r\nAfter some investigation, I found out that the [`SOVERSION` and `VERSION`](https://cmake.org/cmake/help/latest/prop_tgt/SOVERSION.html) properties should not be used when building a shared library. This doesn't seem to lead to an error on Linux, but on macOS, it happens to set the following two flags:\r\n  * `-compatibility_version` (given by `SOVERSION`)\r\n  * `-current_version` (given by `VERSION`)\r\n\r\nHowever, CMake uses the `-bundle` flag when linking, instead of the `-dynamiclib` flag.\r\n\r\nI found a fix by reading the documentation:\r\n\r\n> For shared libraries, the MACHO_COMPATIBILITY_VERSION and MACHO_CURRENT_VERSION\r\n> properties can be used to override the compatibility version and current\r\n> version respectively.\r\n\r\nSetting these two flags to `OFF` removes `-compatibility_version` and `-current_version`.\r\n\r\nPerhaps we should simply remove `SOVERSION` and `VERSION`, as they're only meant to be used for shared libraries?\r\n\r\n## Second issue\r\n\r\nOpenSSL has an API to load dynamic objects and libraries called `DSO`. When loading a provider, a call to `dlfcn_name_converter` is made to compute the name of the file:\r\n\r\nhttps://github.com/openssl/openssl/blob/79fa5873a9c2f2df392bc4b39146d8db37640118/crypto/dso/dso_dlfcn.c#L253-L280\r\n\r\nReader may notice that OpenSSL appends the macro `DSO_EXTENSION` to the end of the provider's name.\r\n`DSO_EXTENSION` is platform-specific: its value is `.so` on Unix, and `.dylib` on macOS.\r\nBecause we're building a `MODULE` library here instead of a `SHARED` library, the output file's extension is `.so` instead of `.dylib`. Thus, OpenSSL fails to find the `oqs-provider` to load.\r\n\r\nTo solve this issue, I used the [`SUFFIX`](https://cmake.org/cmake/help/latest/prop_tgt/SUFFIX.html) property of CMake targets to explicitely specify the extension when building for a XNU-based platform (macOS, iOS, watchOS, etc.).\r\n\r\n<!-- Please give a brief explanation of the purpose of this pull request. -->\r\n\r\n<!-- Does this PR resolve any issue?  If so, please reference it using automatic-closing keywords like \"Fixes #123.\" -->\r\n\r\n<!-- Once your pull request is ready for review and passing continuous integration tests, please convert from a draft PR to a normal PR, and request a review from one of the OQS core team members. -->\r\n","reactions":{"url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/207/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/207/timeline","performed_via_github_app":null,"state_reason":null},"comment":{"url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/comments/1624761266","html_url":"https://github.com/open-quantum-safe/oqs-provider/pull/207#issuecomment-1624761266","issue_url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/207","id":1624761266,"node_id":"IC_kwDOE_A9l85g1-Oy","user":{"login":"baentsch","id":57787676,"node_id":"MDQ6VXNlcjU3Nzg3Njc2","avatar_url":"https://avatars.githubusercontent.com/u/57787676?v=4","gravatar_id":"","url":"https://api.github.com/users/baentsch","html_url":"https://github.com/baentsch","followers_url":"https://api.github.com/users/baentsch/followers","following_url":"https://api.github.com/users/baentsch/following{/other_user}","gists_url":"https://api.github.com/users/baentsch/gists{/gist_id}","starred_url":"https://api.github.com/users/baentsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/baentsch/subscriptions","organizations_url":"https://api.github.com/users/baentsch/orgs","repos_url":"https://api.github.com/users/baentsch/repos","events_url":"https://api.github.com/users/baentsch/events{/privacy}","received_events_url":"https://api.github.com/users/baentsch/received_events","type":"User","site_admin":false},"created_at":"2023-07-07T05:16:13Z","updated_at":"2023-07-07T05:16:13Z","author_association":"MEMBER","body":"Merged: Thanks for the contribution, @thb-sb!","reactions":{"url":"https://api.github.com/repos/open-quantum-safe/oqs-provider/issues/comments/1624761266/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}},"public":true,"created_at":"2023-07-07T05:16:14Z","org":{"id":20689385,"login":"open-quantum-safe","gravatar_id":"","url":"https://api.github.com/orgs/open-quantum-safe","avatar_url":"https://avatars.githubusercontent.com/u/20689385?"}}
